<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --background-light: #f3f4f6; --text-light: #111827; --card-bg-light: #ffffff; --border-light: #d1d5db; --primary-light: #14b8a6; --primary-dark: #0d9488;
            --background-dark: #1f2937; --text-dark: #e5e7eb; --card-bg-dark: #374151; --border-dark: #4b5563; --primary-dark-theme: #2dd4bf; --primary-dark-hover: #5eead4;
        }
        html.dark {
            --background: var(--background-dark); --text-color: var(--text-dark); --card-bg: var(--card-bg-dark); --border-color: var(--border-dark); --primary-color: var(--primary-dark-theme); --primary-hover: var(--primary-dark-hover);
        }
        html.light {
            --background: var(--background-light); --text-color: var(--text-light); --card-bg: var(--card-bg-light); --border-color: var(--border-light); --primary-color: var(--primary-light); --primary-hover: var(--primary-dark);
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text-color); transition: background-color 0.3s, color 0.3s;
        }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        .loader { border-top-color: var(--primary-color); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .surah-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        /* Make space for the fixed player */
        body {
            padding-bottom: 120px; /* Adjust based on player height */
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-loader" class="fixed inset-0 bg-white dark:bg-gray-900 flex flex-col items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        <p class="mt-4 text-xl">Loading Quran...</p>
    </div>

    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Quran Player</h1>
            <button id="theme-toggle" class="p-2 h-10 w-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-xl transition-colors">
                <i class="fas fa-moon"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
             <!-- Settings -->
            <div class="card p-4 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4">Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label for="language-select" class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Language</label>
                        <select id="language-select" class="w-full p-2 border rounded-md bg-transparent border-gray-300 dark:border-gray-600"></select>
                    </div>
                    <div>
                        <label for="reciter-select" class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Reciter</label>
                        <select id="reciter-select" class="w-full p-2 border rounded-md bg-transparent border-gray-300 dark:border-gray-600"></select>
                    </div>
                </div>
            </div>
            <!-- Playlist -->
            <div class="card rounded-2xl shadow-lg flex flex-col">
                <div class="p-4 border-b dark:border-gray-700">
                     <input type="text" id="surah-search" placeholder="Search for a Surah..." class="w-full p-2 border rounded-md bg-transparent border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent">
                </div>
                <div id="playlist" class="overflow-y-auto p-2 h-96">
                    <!-- Surah items will be injected here -->
                </div>
            </div>
        </main>
    </div>
    
    <!-- Fixed Player at the bottom -->
    <div id="player-card" class="fixed bottom-0 left-0 right-0 card p-4 shadow-2xl border-t-2 dark:border-gray-700">
        <div class="container mx-auto flex items-center gap-4">
             <div id="surah-info" class="text-left">
                <h2 id="surah-title" class="text-lg font-bold"></h2>
                <p id="surah-translation" class="text-sm text-gray-500 dark:text-gray-400"></p>
            </div>
            <div id="audio-player-container" class="flex-grow">
                 <audio id="audio-player" controls class="w-full"></audio>
                 <div id="navigation-controls" class="flex justify-between items-center mt-1">
                     <button id="prev-verse-btn" class="p-2 text-xl hover:text-[var(--primary-color)] transition-colors"><i class="fas fa-backward-step"></i></button>
                     <p id="verse-indicator" class="text-sm font-medium">Verse 1 / 1</p>
                     <button id="next-verse-btn" class="p-2 text-xl hover:text-[var(--primary-color)] transition-colors"><i class="fas fa-forward-step"></i></button>
                 </div>
            </div>
        </div>
         <div id="verse-content-container" class="mt-2 text-center text-sm text-gray-600 dark:text-gray-300">
             <p id="verse-text"></p>
        </div>
    </div>
    
    <footer class="text-center w-full py-4 text-sm text-gray-500 dark:text-gray-400 fixed bottom-0 -z-10">
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const appLoader = document.getElementById('app-loader');
        const languageSelect = document.getElementById('language-select');
        const reciterSelect = document.getElementById('reciter-select');
        const audioPlayer = document.getElementById('audio-player');
        const verseTextEl = document.getElementById('verse-text');
        const navControls = document.getElementById('navigation-controls');
        const prevVerseBtn = document.getElementById('prev-verse-btn');
        const nextVerseBtn = document.getElementById('next-verse-btn');
        const verseIndicator = document.getElementById('verse-indicator');
        const surahTitleEl = document.getElementById('surah-title');
        const surahTranslationEl = document.getElementById('surah-translation');
        const playlistEl = document.getElementById('playlist');
        const surahSearchInput = document.getElementById('surah-search');
        const themeToggle = document.getElementById('theme-toggle');

        // State
        let allSurahs = [];
        let currentVerse = 1;
        let totalVerses = 0;
        let currentVerseByVerseData = [];
        let currentSurahNumber = 1;

        const API_QURAN_COM = 'https://api.quran.com/api/v4';
        const API_ALQURAN_CLOUD = 'https://api.alquran.cloud/v1';

        async function initialize() {
            loadSettings();
            languageSelect.innerHTML = `<option value="ar">Arabic</option><option value="en">English</option><option value="ur">Urdu</option>`;
            await populateSurahs();
            await handleLanguageChange();
            appLoader.style.display = 'none';
        }

        async function populateSurahs() {
            try {
                const response = await fetch(`${API_QURAN_COM}/chapters?language=en`);
                if (!response.ok) throw new Error('Failed to fetch Surahs');
                const data = await response.json();
                allSurahs = data.chapters;
                renderPlaylist(allSurahs);
            } catch (error) {
                console.error(error);
            }
        }

        async function populateReciters(lang) {
            try {
                let reciters = [];
                if (lang === 'ar') {
                    const response = await fetch(`${API_QURAN_COM}/resources/recitations?language=en`);
                    if (!response.ok) throw new Error('Failed to fetch reciters');
                    const data = await response.json();
                    reciters = data.recitations.map(r => ({ id: r.id, name: `${r.reciter_name} (${r.style || 'N/A'})` }));
                } else { // English and Urdu
                    const response = await fetch(`${API_ALQURAN_CLOUD}/edition/format/audio`);
                    if (!response.ok) throw new Error(`Failed to fetch ${lang} reciters`);
                    const data = await response.json();
                    reciters = data.data.filter(e => e.language === lang).map(e => ({ id: e.identifier, name: e.englishName }));
                }
                reciterSelect.innerHTML = reciters.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                const savedReciter = localStorage.getItem(`${lang}Reciter`);
                if(savedReciter) reciterSelect.value = savedReciter;

            } catch (error) {
                console.error(error);
            }
        }
        
        async function handleLanguageChange() {
            const lang = languageSelect.value;
            localStorage.setItem('quranLang', lang);
            await populateReciters(lang);
            await updateAudioSource();
        }

        async function updateAudioSource() {
            const lang = languageSelect.value;
            if (lang === 'ar') {
                await fetchArabicAudio();
            } else {
                await fetchVerseByVerseAudio();
            }
        }

        async function fetchArabicAudio() {
            const reciterId = reciterSelect.value;
            if (!currentSurahNumber || !reciterId) return;

            try {
                const response = await fetch(`${API_QURAN_COM}/chapter_recitations/${reciterId}/${currentSurahNumber}`);
                if (!response.ok) throw new Error('Audio for this selection not found.');
                const data = await response.json();
                
                if (data.audio_file && data.audio_file.audio_url) {
                    audioPlayer.src = data.audio_file.audio_url;
                    audioPlayer.play().catch(e => {});
                    updateDisplay(currentSurahNumber);
                    navControls.classList.add('hidden');
                    verseTextEl.textContent = '';
                } else {
                    throw new Error('Audio URL not available.');
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function fetchVerseByVerseAudio() {
            const reciterId = reciterSelect.value;
            if (!currentSurahNumber || !reciterId) return;

            try {
                const response = await fetch(`${API_ALQURAN_CLOUD}/surah/${currentSurahNumber}/${reciterId}`);
                if (!response.ok) throw new Error('Verse by verse audio not found.');
                const data = await response.json();
                
                currentVerseByVerseData = data.data.ayahs;
                totalVerses = data.data.numberOfAyahs;
                currentVerse = 1;
                playVerseByVerse();
                updateDisplay(currentSurahNumber);

            } catch (error) {
                console.error(error);
            }
        }
        
        function updateDisplay(chapterId) {
            const surah = allSurahs.find(s => s.id == chapterId);
            if(surah) {
                surahTitleEl.textContent = `${surah.id}. ${surah.name_simple}`;
                surahTranslationEl.textContent = surah.translated_name.name;
            }
            
            document.querySelectorAll('.surah-item').forEach(item => {
                item.classList.toggle('active', item.dataset.number == chapterId);
            });
        }

        function playVerseByVerse() {
            if (currentVerseByVerseData.length === 0) return;
            
            const verseData = currentVerseByVerseData[currentVerse - 1];
            audioPlayer.src = verseData.audio;
            verseTextEl.textContent = `"${verseData.text}"`;
            verseIndicator.textContent = `Verse ${currentVerse} of ${totalVerses}`;

            navControls.classList.remove('hidden');

            audioPlayer.play().catch(e => {});
        }

        function navigateVerse(direction) {
            let nextVerse = currentVerse + direction;
            if (nextVerse > 0 && nextVerse <= totalVerses) {
                currentVerse = nextVerse;
                playVerseByVerse();
            }
        }
        
        function renderPlaylist(surahsToRender) {
            playlistEl.innerHTML = surahsToRender.map(s => `
                <div class="p-3 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md cursor-pointer surah-item" data-number="${s.id}">
                    <p class="font-semibold">${s.id}. ${s.name_simple}</p>
                    <p class="text-sm text-gray-500">${s.translated_name.name}</p>
                </div>
            `).join('');
        }
        
        function loadSettings() {
            const theme = localStorage.getItem('quranTheme') || 'dark';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
            const lang = localStorage.getItem('quranLang');
            if(lang) languageSelect.value = lang;
        }

        // Event Listeners
        languageSelect.addEventListener('change', handleLanguageChange);
        reciterSelect.addEventListener('change', (e) => {
            localStorage.setItem(`${languageSelect.value}Reciter`, e.target.value);
            updateAudioSource();
        });

        prevVerseBtn.addEventListener('click', () => navigateVerse(-1));
        nextVerseBtn.addEventListener('click', () => navigateVerse(1));
        audioPlayer.addEventListener('ended', () => {
            if (languageSelect.value !== 'ar') {
                navigateVerse(1);
            } else {
                currentSurahNumber = (currentSurahNumber % 114) + 1;
                updateAudioSource();
            }
        });

        surahSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allSurahs.filter(s => s.name_simple.toLowerCase().includes(searchTerm) || s.translated_name.name.toLowerCase().includes(searchTerm));
            renderPlaylist(filtered);
        });

        playlistEl.addEventListener('click', (e) => {
            const surahItem = e.target.closest('.surah-item');
            if (surahItem) {
                currentSurahNumber = parseInt(surahItem.dataset.number, 10);
                updateAudioSource();
            }
        });

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('quranTheme', isDark ? 'dark' : 'light');
            themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        });

        initialize();
    });
    </script>
</body>
</html>
